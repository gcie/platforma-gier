<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket;

        function buildTable(data) {
            var res = "<tr><th>Hostname</th><th>Guestname</th><th>Game type</th><th></th></tr>";
            for(var table in data) {
                res += "<tr><td>" + data[table].hostnick + "</td><td>";
                if(data[table].guestnick) {
                    res += data[table].guestnick + "</td><td>" + data[table].gametype + "</td><td>" + "<button onclick='spectate('" + table + "')'>Oglądaj</button></td>";
                } else {
                    res += "-</td><td>" + data[table].gametype + "</td><td>" + "<button onclick='join('" + table + "')'>Dołącz</button></td></tr>";
                }
            }
            document.getElementById('tables').innerHTML = res;
        }

        function joinTable(tableId) {
            var req = new XMLHttpRequest();
            req.open('post', '/join/' + tableId);
            req.onreadystatechange = function() {
                if ( req.readyState == XMLHttpRequest.DONE ) {
                    
                }
            }
            req.send();
            socket.emit();
        }


        function createTable() {
            var req = new XMLHttpRequest();

            req.open('post', '/tables/create');

            req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

            var gametype = document.getElementById('in-gametype').value;
            var nick = document.getElementById('in-hostnick').value;
            var login = document.getElementById('in-hostname').value;

            req.send(JSON.stringify({
                gametype: gametype,
                hostnick: nick,
                hostname: login
            }));

            req.onreadystatechange = function() {
                if(req.readyState == XMLHttpRequest.DONE) {
                    var data = JSON.parse(req.response);
                    if(data.err) {
                        console.log('data incomplete');
                    } else { 
                        console.log(window.location.hostname + ':' + window.location.port + '/tables/' + data.id);
                        window.location.href = '/tables/' + data.id;
                    }
                }
            };
        }

        window.onload = function() {
            socket = io('/tables');

            socket.on('update-list', function(data) {
                console.log(data);
                buildTable(data);
            });

            document.getElementById('bt-create').addEventListener('click', function() {
                createTable();
            });
        }

    </script>
    <title>Document</title>
</head>
<body>
    <table id='tables'>
    </table>
    </br>
    <table>
        <tr>
            <td colspan=2>
                <div align="center">Nowy stół:</div>
            </td>
        </tr>
        <tr>
            <th>Rodzaj gry:</th>
            <td>
                <select id="in-gametype">
                    <option value="classic8">Classic 8x8</option>
                    <option value="classic10">Classic 10x10</option>
                    <option value="english8">English 8x8</option>
                    <option value="english10">English 10x10</option>
                    <option value="russian8">Russian 8x8</option>
                    <option value="russian10">Russian 10x10</option>
                </select>
            </td>
        </tr>
        <tr>
            <th>Login gracza:</th>
            <th><input type="text" id="in-hostname"></th>
        </tr>
        <tr>
            <th>Nick gracza:</th>
            <th><input type="text" id="in-hostnick"></th>
        </tr>
        <tr>
            <td colspan=2>
                <div align="center">
                    <button id='bt-create'>Utwórz stół</button>
                </div>
            </td>
        </tr>
    </table>
</body>
</html>